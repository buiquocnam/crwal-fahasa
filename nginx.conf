server {
    listen 80;
    server_name localhost;

    # DNS resolver để phân giải tên container
    resolver 127.0.0.11 valid=30s;
    
    # API Gateway - Proxy đến API service
    location /api/ {
        # Loại bỏ tiền tố /api/ khi chuyển tiếp đến API service
        rewrite ^/api/(.*) /$1 break;
        
        # Proxy trực tiếp đến container bằng IP và port cố định
        proxy_pass http://fahasa_api:8000;
        
        # Thiết lập headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Tăng timeout
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # Bật chế độ debug
        error_log /var/log/nginx/api_error.log debug;
        access_log /var/log/nginx/api_access.log;
    }

    # Proxy trực tiếp đến /books endpoint
    location /books/ {
        proxy_pass http://fahasa_api:8000/books/;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Tăng timeout
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # Bật chế độ debug
        error_log /var/log/nginx/books_error.log debug;
        access_log /var/log/nginx/books_access.log;
    }

    # Proxy đến Web service
    location / {
        proxy_pass http://fahasa_web:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Tăng timeout
        proxy_connect_timeout 300s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }
} 